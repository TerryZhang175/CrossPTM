<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CrossPTM Analysis</title>
    <style>
      :root {
        --primary: #2563eb;
        --primary-hover: #1d4ed8;
        --bg-color: #f3f4f6;
        --card-bg: #ffffff;
        --text-main: #1f2937;
        --text-muted: #6b7280;
        --border-color: #e5e7eb;
        --success-bg: #def7ec;
        --success-text: #03543f;
        --error-bg: #fde8e8;
        --error-text: #9b1c1c;
        --radius: 8px;
        --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-main);
        margin: 0;
        padding: 20px;
        line-height: 1.5;
      }

      main {
        max-width: 1000px;
        margin: 0 auto;
        display: grid;
        gap: 24px;
      }

      header {
        text-align: center;
        margin-bottom: 10px;
      }

      h1 {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        color: #111827;
      }

      p.subtitle {
        color: var(--text-muted);
        font-size: 1.1rem;
      }

      section {
        background: var(--card-bg);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 24px;
        border: 1px solid var(--border-color);
      }

      h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin-top: 0;
        margin-bottom: 16px;
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 12px;
      }

      h3 {
        font-size: 1.1rem;
        margin: 16px 0 8px 0;
      }

      label {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        color: #374151;
        margin-bottom: 4px;
        margin-top: 12px;
      }

      input[type="text"],
      input[type="file"] {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 0.95rem;
        transition: border-color 0.15s;
      }

      input[type="text"]:focus,
      input[type="file"]:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
      }

      .btn-group {
        margin-top: 20px;
        display: flex;
        gap: 12px;
      }

      button {
        background-color: var(--primary);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.95rem;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      button:hover {
        background-color: var(--primary-hover);
      }

      button.secondary {
        background-color: #fff;
        border: 1px solid #d1d5db;
        color: #374151;
      }

      button.secondary:hover {
        background-color: #f9fafb;
        border-color: #9ca3af;
      }

      .ptm-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 12px;
      }

      .ptm-item {
        display: flex;
        align-items: center;
        padding: 8px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        transition: background-color 0.15s;
      }

      .ptm-item:hover {
        background-color: #f9fafb;
      }

      .ptm-item label {
        margin: 0;
        display: flex;
        align-items: center;
        width: 100%;
        cursor: pointer;
      }

      .ptm-item input {
        margin-right: 8px;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        padding: 2px 8px;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: auto;
      }

      .badge.ok {
        background-color: var(--success-bg);
        color: var(--success-text);
      }

      .badge.missing {
        background-color: var(--error-bg);
        color: var(--error-text);
      }

      .status {
        margin-top: 16px;
        padding: 12px;
        border-radius: 6px;
        font-size: 0.9rem;
        background-color: #f0f9ff;
        color: #0c4a6e;
        border-left: 4px solid #0ea5e9;
      }

      .status.error {
        background-color: var(--error-bg);
        color: var(--error-text);
        border-left-color: #dc2626;
      }

      .status.success {
        background-color: var(--success-bg);
        color: var(--success-text);
        border-left-color: #059669;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
        margin-top: 16px;
      }

      th {
        text-align: left;
        background-color: #f9fafb;
        padding: 10px;
        font-weight: 600;
        border-bottom: 2px solid var(--border-color);
      }

      td {
        padding: 10px;
        border-bottom: 1px solid var(--border-color);
      }

      tr:last-child td {
        border-bottom: none;
      }

      pre {
        background-color: #111827;
        color: #e5e7eb;
        padding: 16px;
        border-radius: 6px;
        font-size: 0.85rem;
        overflow-x: auto;
        white-space: pre-wrap;
      }

      progress {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        overflow: hidden;
      }
      
      progress::-webkit-progress-bar {
        background-color: #e5e7eb;
      }
      
      progress::-webkit-progress-value {
        background-color: var(--primary);
      }

      a {
        color: var(--primary);
        text-decoration: none;
        font-weight: 500;
      }
      
      a:hover {
        text-decoration: underline;
      }

      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .grid-2 {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>CrossPTM Analysis</h1>
      <p class="subtitle">Interactive Structural PTM Crosstalk Analysis Pipeline</p>
    </header>

    <main>
      <!-- Primary Input Section -->
      <section>
        <h2>1. Primary PTM Input</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 16px;">
          Upload the dataset for the main PTM under study (e.g., Glutathionylation).
        </p>
        <form id="primary-form">
          <div class="grid-2">
            <div>
              <label>PTM Name</label>
              <input type="text" name="primary_ptm_name" value="Glutathionylation" required />
            </div>
            <div>
              <label>Target Residues (Optional)</label>
              <input type="text" name="target_residues" placeholder="e.g. C or S,T,Y" />
            </div>
          </div>
          
          <div class="grid-2">
            <div>
              <label>UniProt Column Name</label>
              <input type="text" name="uniprot_column" value="UniProt_ID" />
            </div>
            <div>
              <label>Site Column Name</label>
              <input type="text" name="site_column" value="Glutathione_Site" />
            </div>
          </div>

          <div>
            <label>Upload File (CSV/TXT/TSV)</label>
            <input type="file" name="file" required />
          </div>

          <div class="btn-group">
            <button type="submit">Save Primary PTM</button>
          </div>
        </form>
        
        <div id="primary-status"></div>
        
        <div id="structure-container" style="margin-top: 20px; display: none;">
           <h3 style="font-size: 1rem; color: #374151;">AlphaFold Structure Fetcher</h3>
           <div id="structure-status" style="font-size: 0.9rem; color: var(--text-muted);"></div>
           <div style="margin-top: 8px;">
             <progress id="structure-progress-bar" value="0" max="1"></progress>
           </div>
        </div>
      </section>

      <!-- PTM Selection Section -->
      <section>
        <h2>2. Select Crosstalk PTMs</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem;">Choose which PTM datasets to analyze against your primary PTM.</p>
        <div id="ptm-container" class="ptm-list"></div>
      </section>

      <!-- Custom PTM Upload Section -->
      <section>
        <h2>3. Add Custom PTM Dataset</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem;">Upload additional PTM data to include in the analysis.</p>
        <form id="custom-form">
          <div class="grid-2">
            <div>
              <label>New PTM Name</label>
              <input type="text" name="ptm_name" placeholder="e.g. SUMOylation" required />
            </div>
            <div>
              <label>Allowed Residues (Optional)</label>
              <input type="text" name="allowed_residues" placeholder="e.g. K or K,R" />
            </div>
          </div>
          <div>
            <label>Upload File</label>
            <input type="file" name="file" required />
          </div>
          <div class="btn-group">
            <button type="submit">Add Custom PTM</button>
          </div>
        </form>
        <div id="custom-status"></div>
      </section>

      <!-- Execution Section -->
      <section>
        <h2>4. Run Analysis</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem;">
          Execute the pipeline: Data Loader &rarr; Distance Computation &rarr; Enrichment Analysis.
        </p>
        <div style="margin-bottom: 16px;">
           <label style="display:inline-flex; align-items:center; cursor:pointer;">
             <input type="checkbox" id="sasa-checkbox" style="width:auto; margin-right:8px;">
             Compute SASA (Solvent Accessible Surface Area) Analysis
           </label>
           <p style="margin:4px 0 0 24px; font-size:0.8rem; color:var(--text-muted);">
             This calculates surface accessibility for modified vs. control cysteines to see if crosstalk affects exposure.
           </p>
        </div>
        <div class="btn-group">
          <button id="run-btn">Run Pipeline</button>
          <button id="refresh-btn" class="secondary" type="button">Refresh Results Only</button>
        </div>
        <div id="run-logs-container" style="margin-top: 20px; display: none;">
            <h3>Execution Logs</h3>
            <div id="run-logs"></div>
        </div>
      </section>

      <!-- Results Section -->
      <section>
        <h2>5. Results</h2>
        <div id="downloads" style="margin-bottom: 16px;"></div>
        <div id="results-summary"></div>
        <div id="sasa-summary" style="margin-top:24px;"></div>
        <div id="enrichment"></div>
      </section>
    </main>

    <script>
      const ptmContainer = document.getElementById("ptm-container");
      const primaryForm = document.getElementById("primary-form");
      const primaryStatus = document.getElementById("primary-status");
      const structureContainer = document.getElementById("structure-container");
      const structureStatus = document.getElementById("structure-status");
      const structureProgressBar = document.getElementById("structure-progress-bar");
      
      const customForm = document.getElementById("custom-form");
      const customStatus = document.getElementById("custom-status");
      
      const runBtn = document.getElementById("run-btn");
      const refreshBtn = document.getElementById("refresh-btn");
      const sasaCheckbox = document.getElementById("sasa-checkbox");
      const runLogsContainer = document.getElementById("run-logs-container");
      const runLogs = document.getElementById("run-logs");
      
      const resultsSummary = document.getElementById("results-summary");
      const downloads = document.getElementById("downloads");
      const enrichment = document.getElementById("enrichment");
      const sasaSummaryDiv = document.getElementById("sasa-summary");
      
      let structurePoll = null;

      async function fetchJSON(url, options = {}) {
        const resp = await fetch(url, options);
        if (!resp.ok) {
          const payload = await resp.json().catch(() => ({}));
          throw new Error(payload.detail || resp.statusText);
        }
        return resp.json();
      }

      function renderStatus(el, text, type = "neutral") {
        el.textContent = text;
        el.className = "status";
        if (type === "error") el.classList.add("error");
        if (type === "success") el.classList.add("success");
        el.style.display = text ? "block" : "none";
      }

      async function loadPtms() {
        const data = await fetchJSON("/api/ptms");
        ptmContainer.innerHTML = "";
        data.ptms.forEach((item) => {
          const div = document.createElement("div");
          div.className = "ptm-item";
          
          const label = document.createElement("label");
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = item.name;
          checkbox.disabled = !item.available;
          
          label.appendChild(checkbox);
          
          const spanName = document.createElement("span");
          spanName.textContent = item.name;
          if (item.source === "custom") {
             spanName.textContent += " (Custom)";
          }
          label.appendChild(spanName);
          
          // Badges
          if (item.available) {
             const badge = document.createElement("span");
             badge.className = "badge ok";
             badge.textContent = "Available";
             label.appendChild(badge);
          } else {
             const badge = document.createElement("span");
             badge.className = "badge missing";
             badge.textContent = "Missing";
             label.appendChild(badge);
          }

          if (item.allowed_residues && item.allowed_residues.length) {
            const resBadge = document.createElement("span");
            resBadge.className = "badge ok";
            resBadge.style.marginLeft = "4px";
            resBadge.style.backgroundColor = "#e0f2fe"; // light blue
            resBadge.style.color = "#0284c7";
            resBadge.textContent = item.allowed_residues.join("/");
            label.appendChild(resBadge);
          }

          div.appendChild(label);
          ptmContainer.appendChild(div);
        });
      }

      function selectedPtms() {
        return Array.from(ptmContainer.querySelectorAll("input[type='checkbox']:checked")).map(
          (el) => el.value
        );
      }

      primaryForm.addEventListener("submit", async (ev) => {
        ev.preventDefault();
        const formData = new FormData(primaryForm);
        renderStatus(primaryStatus, "");
        try {
          const resp = await fetchJSON("/api/primary", {
            method: "POST",
            body: formData,
          });
          const filtered = resp.info.filtered_by_residue || 0;
          const target = resp.info.target_residues && resp.info.target_residues.length
            ? "; Target Residues: " + resp.info.target_residues.join(",")
            : "";
          const dropped = filtered ? ` (${filtered} rows filtered by residue)` : "";
          
          renderStatus(primaryStatus, `Saved ${resp.info.rows} primary PTM sites${dropped}${target}.`, "success");
          
          updateStructureStatus(resp.info.structure_fetch);
          startStructurePolling();
        } catch (err) {
          renderStatus(primaryStatus, err.message, "error");
          structureContainer.style.display = "none";
        }
      });

            runBtn.addEventListener("click", async () => {
              runLogsContainer.style.display = "block";
              runLogs.innerHTML = "<pre>Running...</pre>";
              resultsSummary.textContent = "";
              sasaSummaryDiv.innerHTML = "";
              try {
                const resp = await fetchJSON("/api/run", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ 
                      ptm_types: selectedPtms(),
                      compute_sasa: sasaCheckbox.checked
                  }),
                });
                renderLogs(resp.logs);
                renderSummary(resp.summary);
              } catch (err) {
                runLogs.textContent = "";
                renderStatus(runLogs, err.message, "error");
              }
            });
      
            refreshBtn.addEventListener("click", async () => {
              await loadResults();
            });
      
            // ... (rest of code)
      
            function renderSummary(summary) {
              if (!summary) {
                resultsSummary.textContent = "No results available.";
                return;
              }
              const selected = summary.selected_ptms && summary.selected_ptms.length
                ? summary.selected_ptms.join(", ")
                : "All PTMs";
              
              let html = `<div style="margin-bottom: 12px;"><strong>Analyzed:</strong> ${selected}</div>`;
              html += `<div><strong>Total Pairs:</strong> ${summary.pair_count || 0}</div>`;
      
              if (summary.ptm_breakdown && summary.ptm_breakdown.length) {
                html += "<table><thead><tr><th>PTM Type</th><th>Pairs</th><th>Avg Dist (Å)</th><th>≤5Å</th><th>≤8Å</th><th>≤10Å</th></tr></thead><tbody>";
                summary.ptm_breakdown.forEach((row) => {
                  const avg =
                    row.mean_distance === null || row.mean_distance === undefined
                      ? "NA"
                      : Number(row.mean_distance).toFixed(2);
                  html += `<tr>
                      <td>${row.ptm_type}</td>
                      <td>${row.pair_count}</td>
                      <td>${avg}</td>
                      <td>${row.contacts_5A}</td>
                      <td>${row.contacts_8A}</td>
                      <td>${row.contacts_10A}</td>
                  </tr>`;
                });
                html += "</tbody></table>";
              } else {
                html += "<p style='margin-top:10px; color:var(--text-muted);'>No matches found for the selected PTMs.</p>";
              }
              resultsSummary.innerHTML = html;
      
              // Downloads
              const links = [];
              if (summary.distances_path) {
                links.push(`<a href="/${summary.distances_path}" target="_blank">Download distances.csv</a>`);
              }
              if (summary.ptm_sites_path) {
                links.push(`<a href="/${summary.ptm_sites_path}" target="_blank">Download ptm_sites.filtered.csv</a>`);
              }
              if (summary.enrichment_path) {
                links.push(`<a href="/${summary.enrichment_path}" target="_blank">View Enrichment Report</a>`);
              }
              if (summary.sasa_report_path) {
                links.push(`<a href="/${summary.sasa_report_path}" target="_blank">Download SASA Summary (CSV)</a>`);
              }
              downloads.innerHTML = links.length ? links.join(" | ") : "";
      
              // SASA Summary
              if (summary.sasa_markdown && summary.sasa_markdown.length) {
                  sasaSummaryDiv.innerHTML = summary.sasa_markdown.join("<br>").replace(/^### (.*)/, "<h3>$1</h3>").replace(/\|/g, " ").replace(/- \*\*/g, "<br>&bull; <strong>").replace(/\*\*/g, "</strong>");
                  // A simple parser for the table is better
                  let sasaHtml = "";
                  let inTable = false;
                  summary.sasa_markdown.forEach(line => {
                      if (line.startsWith("|")) {
                          if (!inTable) {
                              sasaHtml += "<table style='width:auto; margin-bottom:12px;'>";
                              inTable = true;
                          }
                          if (line.includes("---")) return; // Skip separator
                          const cells = line.split("|").filter(c => c.trim() !== "");
                          sasaHtml += "<tr>" + cells.map(c => `<td style='border:1px solid #e5e7eb; padding:6px;'>${c.trim()}</td>`).join("") + "</tr>";
                      } else {
                          if (inTable) {
                              sasaHtml += "</table>";
                              inTable = false;
                          }
                          if (line.startsWith("###")) sasaHtml += `<h3>${line.replace("###", "")}</h3>`;
                          else if (line.startsWith("**Definitions")) sasaHtml += `<h4>Definitions</h4>`;
                          else if (line.startsWith("- **")) sasaHtml += `<div>&bull; ${line.substring(2).replace(/\*\*(.*?)\*\*/, "<strong>$1</strong>")}</div>`;
                          else if (line.trim() !== "") sasaHtml += `<p>${line}</p>`;
                      }
                  });
                  if (inTable) sasaHtml += "</table>";
                  sasaSummaryDiv.innerHTML = sasaHtml;
              } else {
                  sasaSummaryDiv.innerHTML = "";
              }
      
              if (summary.enrichment_markdown && summary.enrichment_markdown.length) {
                enrichment.innerHTML =
                  "<h3>Enrichment Analysis</h3><pre>" +
                  summary.enrichment_markdown.join("\n") +
                  "</pre>";
              } else {
                enrichment.textContent = "";
              }
            }
      async function loadResults() {
        const params = new URLSearchParams();
        selectedPtms().forEach((ptm) => params.append("ptm", ptm));
        try {
          const data = await fetchJSON(`/api/results?${params.toString()}`);
          renderSummary(data);
        } catch (err) {
          resultsSummary.innerHTML = `<div class="status error">${err.message}</div>`;
        }
      }

      async function bootstrap() {
        await loadPtms();
        resultsSummary.textContent = "No analysis run yet.";
        enrichment.textContent = "";
      }
      bootstrap();
    </script>
  </body>
</html>